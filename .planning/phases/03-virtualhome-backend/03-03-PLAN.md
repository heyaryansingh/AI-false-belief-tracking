---
phase: 03-virtualhome-backend
plan: 03
type: execute
depends_on: ["03-02"]
files_modified: [src/bsa/envs/virtualhome/recorder.py, src/bsa/envs/virtualhome/observability.py, src/bsa/envs/virtualhome/episode_generator.py, src/bsa/envs/virtualhome/__init__.py]
domain: python
---

<objective>
Create VirtualHome episode recorder and enhanced observability module.

Purpose: Enable saving VirtualHome episodes to Parquet/JSONL formats (matching GridHouse) and provide enhanced observability for debugging and analysis. This ensures VirtualHome episodes can be saved, loaded, and analyzed just like GridHouse episodes.

Output: VirtualHomeEpisodeRecorder class, observability module for VirtualHome, integration with episode generator.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-virtualhome-backend/03-02-SUMMARY.md
@src/bsa/envs/gridhouse/recorder.py
@src/bsa/common/types.py
@src/bsa/envs/virtualhome/episode_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VirtualHomeEpisodeRecorder class</name>
  <files>src/bsa/envs/virtualhome/recorder.py, src/bsa/envs/virtualhome/__init__.py</files>
  <action>
    Create `VirtualHomeEpisodeRecorder` class in `src/bsa/envs/virtualhome/recorder.py` that mirrors `EpisodeRecorder` from GridHouse.
    
    The class should:
    - Implement `save_episode()` method that saves episodes to Parquet or JSONL format
    - Support both formats (Parquet primary, JSONL fallback)
    - Use same serialization approach as GridHouseEpisodeRecorder:
      - Flatten nested structures (ObjectLocation, Observation) for Parquet
      - Handle enums and dataclasses for JSONL
      - Use episode_id for file naming
      - Save to `data/episodes/` directory
    
    Reuse the serialization logic from GridHouseEpisodeRecorder (can import or duplicate - ensure compatibility).
    
    Export `VirtualHomeEpisodeRecorder` from `src/bsa/envs/virtualhome/__init__.py`.
    
    Ensure saved episodes are compatible with GridHouse episodes (same schema/structure).
  </action>
  <verify>
    Run `python -c "from src.bsa.envs.virtualhome import VirtualHomeEpisodeGenerator, VirtualHomeEpisodeRecorder, VirtualHomeEnvironment; env = VirtualHomeEnvironment(); gen = VirtualHomeEpisodeGenerator(env); episode = gen.generate_episode(); rec = VirtualHomeEpisodeRecorder(); rec.save_episode(episode, format='parquet'); print('Saved OK')"` - should save episode without errors.
  </verify>
  <done>VirtualHomeEpisodeRecorder exists, can save episodes to Parquet and JSONL, compatible with GridHouse format</done>
</task>

<task type="auto">
  <name>Task 2: Create observability module for VirtualHome</name>
  <files>src/bsa/envs/virtualhome/observability.py, src/bsa/envs/virtualhome/__init__.py</files>
  <action>
    Create `src/bsa/envs/virtualhome/observability.py` module that provides enhanced observability for VirtualHome environments.
    
    The module should include:
    - `get_scene_state()`: Get full scene state (rooms, objects, agents, containers)
    - `get_agent_view(agent_id: str)`: Get what an agent can see (objects, containers, rooms)
    - `get_object_trajectory(object_id: str, episode: Episode)`: Track object movement over episode
    - `visualize_episode(episode: Episode)`: Generate visualization of episode (optional - can be text-based or use matplotlib)
    - `analyze_observability(episode: Episode)`: Analyze what each agent observed vs. true state
    
    These functions help with:
    - Debugging episode generation
    - Understanding partial observability
    - Analyzing false-belief scenarios
    - Visualizing agent behavior
    
    Use VirtualHomeEnvironment methods to query scene state. Return structured data (dicts, lists) that can be used for analysis.
    
    Export key functions from `src/bsa/envs/virtualhome/__init__.py`.
    
    Integrate recorder into episode generator's `generate_episodes()` method (optional save_path parameter).
  </action>
  <verify>
    Run `python -c "from src.bsa.envs.virtualhome import VirtualHomeEnvironment, get_scene_state; env = VirtualHomeEnvironment(); env.reset(); state = get_scene_state(env); print(f'Rooms: {len(state.get(\"rooms\", []))}')"` - should return scene state without errors.
  </verify>
  <done>Observability module exists, provides scene state queries and analysis functions, integrated with episode generator</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] VirtualHomeEpisodeRecorder can save episodes to Parquet
- [ ] VirtualHomeEpisodeRecorder can save episodes to JSONL
- [ ] Saved episodes are compatible with GridHouse episode format
- [ ] Observability module provides scene state queries
- [ ] Episode generator integrates with recorder (optional save_path)
</verification>

<success_criteria>

- VirtualHomeEpisodeRecorder implemented and working
- Observability module provides useful debugging/analysis functions
- Episodes can be saved and loaded
- Ready for Plan 03-04 (Tests and end-to-end verification)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-virtualhome-backend/03-03-SUMMARY.md`:

# Phase 3 Plan 3: VirtualHome Recorder & Enhanced Observability Summary

**Implemented VirtualHome episode recorder and observability module**

## Accomplishments

- Created VirtualHomeEpisodeRecorder for Parquet/JSONL serialization
- Implemented observability module with scene state queries
- Episode saving and loading working
- Enhanced debugging and analysis capabilities

## Files Created/Modified

- `src/bsa/envs/virtualhome/recorder.py` - VirtualHomeEpisodeRecorder class
- `src/bsa/envs/virtualhome/observability.py` - Observability module
- `src/bsa/envs/virtualhome/episode_generator.py` - Integration with recorder
- `src/bsa/envs/virtualhome/__init__.py` - Export new classes

## Decisions Made

- Episode serialization format compatibility with GridHouse
- Observability module API design (what functions to expose)
- Integration approach (recorder in episode generator vs. separate)

## Issues Encountered

[Any serialization issues, observability challenges, etc.]

## Next Step

Ready for 03-04-PLAN.md (VirtualHome-specific tests and end-to-end verification)
</output>
