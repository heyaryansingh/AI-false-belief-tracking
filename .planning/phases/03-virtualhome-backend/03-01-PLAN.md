---
phase: 03-virtualhome-backend
plan: 01
type: execute
depends_on: []
files_modified: [src/bsa/envs/virtualhome/env.py, src/bsa/envs/virtualhome/__init__.py, scripts/install_virtualhome.py, pyproject.toml]
domain: python
---

<objective>
Set up VirtualHome installation and create basic VirtualHomeEnvironment adapter implementing the Environment interface.

Purpose: Enable VirtualHome as an alternative backend to GridHouse, ensuring it implements the same interface for seamless integration. This plan focuses on installation verification and basic environment adapter.

Output: VirtualHome installation script, VirtualHomeEnvironment class implementing Environment interface, basic observability methods.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/bsa/envs/base.py
@src/bsa/envs/gridhouse/env.py
@src/bsa/common/types.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research VirtualHome Python package and create installation script</name>
  <files>scripts/install_virtualhome.py, pyproject.toml, src/bsa/envs/virtualhome/install_notes.md</files>
  <action>
    Research VirtualHome Python package (likely from GitHub: xavierpuigf/virtualhome or similar). Create installation script `scripts/install_virtualhome.py` that:
    1. Checks if VirtualHome is already installed
    2. Attempts to install via pip (check actual package name - may be `virtualhome`, `virtual-home`, or require git install)
    3. Verifies installation by importing and checking version
    4. Provides clear error messages if installation fails
    5. Updates `pyproject.toml` optional-dependencies section with correct VirtualHome package name
    
    Update `install_notes.md` with actual installation instructions based on research findings.
    
    Handle gracefully: If VirtualHome cannot be installed, the script should exit with clear message but not crash. GridHouse fallback ensures the project still works.
  </action>
  <verify>
    Run `python scripts/install_virtualhome.py` - should install VirtualHome or provide clear error message. Check `pip list | grep -i virtual` shows VirtualHome if installed.
  </verify>
  <done>Installation script exists, pyproject.toml updated, install_notes.md updated with actual instructions</done>
</task>

<task type="auto">
  <name>Task 2: Create VirtualHomeEnvironment class implementing Environment interface</name>
  <files>src/bsa/envs/virtualhome/env.py, src/bsa/envs/virtualhome/__init__.py</files>
  <action>
    Create `VirtualHomeEnvironment` class in `src/bsa/envs/virtualhome/env.py` that implements the `Environment` abstract base class from `src/bsa/envs/base.py`. 
    
    The class must implement:
    - `reset(seed: Optional[int]) -> Observation`: Initialize VirtualHome scene, place agents, return initial observation
    - `step(action: Action, agent_id: str) -> Tuple[Observation, float, bool, Dict[str, Any]]`: Execute action in VirtualHome, return observation, reward, done, info
    - `get_true_state() -> Dict[str, Any]`: Return privileged state information
    - `get_visible_state(agent_id: str) -> Observation`: Return partial observation for agent (based on VirtualHome's visibility/observability)
    - `get_object_locations() -> Dict[str, ObjectLocation]`: Extract object locations from VirtualHome scene state
    
    Use VirtualHome API to:
    - Initialize scene (rooms, objects, agents)
    - Execute actions (move, pickup, place, open, close, etc.)
    - Query scene state for object positions
    - Get agent observations (what objects/containers are visible)
    
    Map VirtualHome actions to our `Action` enum. Handle partial observability - agents only see objects/containers in their current room or within visibility range.
    
    Initialize with seed for reproducibility. Store VirtualHome scene instance internally.
    
    Export `VirtualHomeEnvironment` from `src/bsa/envs/virtualhome/__init__.py`.
    
    Note: This is a basic implementation - full task programs and enhanced observability come in later plans. Focus on getting the interface working.
  </action>
  <verify>
    Run `python -c "from src.bsa.envs.virtualhome import VirtualHomeEnvironment; env = VirtualHomeEnvironment(); obs = env.reset(); print('OK')"` - should create environment and reset without errors.
  </verify>
  <done>VirtualHomeEnvironment class exists, implements Environment interface, can reset and return observations</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>VirtualHome installation script and basic VirtualHomeEnvironment adapter</what-built>
  <how-to-verify>
    1. Run: `python scripts/install_virtualhome.py`
    2. Verify: VirtualHome installs successfully OR clear error message if it cannot
    3. Run: `python -c "from src.bsa.envs.virtualhome import VirtualHomeEnvironment; env = VirtualHomeEnvironment(); obs = env.reset(seed=42); print(f'Reset OK: {obs.current_room}')"`
    4. Verify: Environment initializes and reset works
    5. Check: `src/bsa/envs/virtualhome/env.py` implements all required Environment methods
    6. Verify: No import errors, basic functionality works
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python scripts/install_virtualhome.py` runs without crashes
- [ ] `VirtualHomeEnvironment` can be imported and instantiated
- [ ] `env.reset()` returns valid Observation
- [ ] All Environment interface methods are implemented (reset, step, get_true_state, get_visible_state, get_object_locations)
- [ ] No import errors or missing dependencies
</verification>

<success_criteria>

- Installation script created and functional
- VirtualHomeEnvironment class implements Environment interface
- Basic observability methods work (get_visible_state, get_object_locations)
- Installation verification passes
- Ready for Plan 03-02 (Task programs and episode generator)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-virtualhome-backend/03-01-SUMMARY.md`:

# Phase 3 Plan 1: VirtualHome Installation & Basic Environment Adapter Summary

**Implemented VirtualHome installation script and basic environment adapter**

## Accomplishments

- Created installation script for VirtualHome Python package
- Implemented VirtualHomeEnvironment class implementing Environment interface
- Basic observability methods (get_visible_state, get_object_locations)
- Installation verification working

## Files Created/Modified

- `scripts/install_virtualhome.py` - Installation script
- `src/bsa/envs/virtualhome/env.py` - VirtualHomeEnvironment class
- `src/bsa/envs/virtualhome/__init__.py` - Export VirtualHomeEnvironment
- `src/bsa/envs/virtualhome/install_notes.md` - Updated installation instructions
- `pyproject.toml` - Updated optional-dependencies with VirtualHome

## Decisions Made

- VirtualHome package name and installation method (from research)
- How to map VirtualHome API to Environment interface
- Partial observability approach (room-based or visibility-radius based)

## Issues Encountered

[Any installation issues, API mapping challenges, etc.]

## Next Step

Ready for 03-02-PLAN.md (Task programs library and episode generator)
</output>
