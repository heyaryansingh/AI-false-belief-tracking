---
phase: 03-virtualhome-backend
plan: 04
type: execute
depends_on: ["03-03"]
files_modified: [tests/test_virtualhome.py, tests/test_virtualhome_integration.py, src/bsa/envs/virtualhome/__init__.py]
domain: python
---

<objective>
Create VirtualHome-specific tests and end-to-end verification.

Purpose: Ensure VirtualHome integration works correctly, handles edge cases, and can be verified independently. This includes unit tests for VirtualHome components, integration tests with helper agents, and end-to-end verification of episode generation.

Output: Comprehensive test suite for VirtualHome, integration tests, end-to-end verification script.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-virtualhome-backend/03-03-SUMMARY.md
@src/bsa/envs/virtualhome/env.py
@src/bsa/envs/virtualhome/episode_generator.py
@src/bsa/envs/virtualhome/recorder.py
@src/bsa/envs/gridhouse/env.py
@src/bsa/agents/helper/base.py
@tests/test_env_interface.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VirtualHome unit tests</name>
  <files>tests/test_virtualhome.py</files>
  <action>
    Create `tests/test_virtualhome.py` with comprehensive unit tests for VirtualHome components.
    
    Tests should cover:
    - VirtualHomeEnvironment:
      - `test_reset()`: Environment resets correctly with seed
      - `test_step()`: Actions execute correctly (move, pickup, place, open, close)
      - `test_get_visible_state()`: Partial observability works (agent sees only visible objects)
      - `test_get_object_locations()`: Object locations are tracked correctly
      - `test_get_true_state()`: True state matches environment state
    - VirtualHomeEpisodeGenerator:
      - `test_generate_episode()`: Episode generation works
      - `test_intervention()`: False-belief interventions work correctly
      - `test_belief_tracking()`: Human agent beliefs update correctly
      - `test_episode_structure()`: Episode has correct structure (steps, metadata)
    - VirtualHomeEpisodeRecorder:
      - `test_save_parquet()`: Parquet serialization works
      - `test_save_jsonl()`: JSONL serialization works
      - `test_load_episode()`: Episodes can be loaded (if load method exists)
    - Observability module:
      - `test_get_scene_state()`: Scene state queries work
      - `test_agent_view()`: Agent view queries work
    
    Use pytest fixtures for VirtualHomeEnvironment setup. Handle VirtualHome installation gracefully - skip tests if VirtualHome not installed (use pytest.skip or try/except).
    
    Ensure tests are deterministic (use seeds). Test edge cases (empty scenes, no objects, invalid actions).
  </action>
  <verify>
    Run `pytest tests/test_virtualhome.py -v` - should run all tests, skip if VirtualHome not installed, pass if installed.
  </verify>
  <done>Unit tests exist, cover all VirtualHome components, handle missing installation gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Create VirtualHome integration tests and end-to-end verification</name>
  <files>tests/test_virtualhome_integration.py, scripts/verify_virtualhome.py</files>
  <action>
    Create `tests/test_virtualhome_integration.py` with integration tests:
    - `test_helper_agents_with_virtualhome()`: Test that helper agents (ReactiveHelper, GoalOnlyHelper, BeliefSensitiveHelper) work with VirtualHomeEnvironment
    - `test_episode_generation_end_to_end()`: Full episode generation with helper agent assistance
    - `test_false_belief_detection()`: Belief-sensitive helper detects false beliefs in VirtualHome episodes
    - `test_episode_compatibility()`: VirtualHome episodes are compatible with GridHouse episodes (same structure)
    
    Create `scripts/verify_virtualhome.py` script for end-to-end verification:
    - Check VirtualHome installation
    - Create VirtualHomeEnvironment
    - Generate a test episode
    - Verify episode structure
    - Test helper agents with VirtualHome
    - Print verification results
    
    This script can be run independently to verify VirtualHome integration works. Should provide clear pass/fail output.
    
    Ensure integration tests handle VirtualHome gracefully (skip if not installed).
  </action>
  <verify>
    Run `python scripts/verify_virtualhome.py` - should verify VirtualHome integration end-to-end and print results. Run `pytest tests/test_virtualhome_integration.py -v` - should run integration tests.
  </verify>
  <done>Integration tests exist, end-to-end verification script works, helper agents integrate with VirtualHome</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All unit tests pass (or skip gracefully if VirtualHome not installed)
- [ ] Integration tests pass
- [ ] End-to-end verification script runs successfully
- [ ] Helper agents work with VirtualHomeEnvironment
- [ ] Episode generation works end-to-end
- [ ] False-belief detection works in VirtualHome
</verification>

<success_criteria>

- Comprehensive test suite for VirtualHome components
- Integration tests verify helper agents work with VirtualHome
- End-to-end verification script confirms full integration
- Tests handle missing VirtualHome gracefully
- Phase 3 complete - VirtualHome backend fully integrated
  </success_criteria>

<output>
After completion, create `.planning/phases/03-virtualhome-backend/03-04-SUMMARY.md`:

# Phase 3 Plan 4: VirtualHome Tests & End-to-End Verification Summary

**Implemented comprehensive test suite and end-to-end verification for VirtualHome**

## Accomplishments

- Created unit tests for all VirtualHome components
- Implemented integration tests with helper agents
- Created end-to-end verification script
- Tests handle missing VirtualHome gracefully

## Files Created/Modified

- `tests/test_virtualhome.py` - Unit tests for VirtualHome components
- `tests/test_virtualhome_integration.py` - Integration tests
- `scripts/verify_virtualhome.py` - End-to-end verification script

## Decisions Made

- Test structure and organization
- How to handle missing VirtualHome (skip vs. fail)
- Integration test approach (helper agents + VirtualHome)

## Issues Encountered

[Any test failures, integration issues, etc.]

## Next Step

Phase 3 complete. Ready for Phase 4 (Experiment Harness + Reproducibility) or Phase 5 (Metrics + Analysis).
</output>
