---
phase: 03-virtualhome-backend
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [src/bsa/envs/virtualhome/tasks.py, src/bsa/envs/virtualhome/episode_generator.py, src/bsa/envs/virtualhome/__init__.py]
domain: python
---

<objective>
Create VirtualHome task programs library and episode generator for VirtualHome environment.

Purpose: Enable episode generation with false-belief interventions in VirtualHome, matching the functionality of GridHouseEpisodeGenerator. This includes task definitions specific to VirtualHome scenes and an episode generator that orchestrates human agent behavior and interventions.

Output: VirtualHome task programs library, VirtualHomeEpisodeGenerator class, integration with ScriptedHumanAgent.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-virtualhome-backend/03-01-SUMMARY.md
@src/bsa/envs/gridhouse/tasks.py
@src/bsa/envs/gridhouse/episode_generator.py
@src/bsa/common/types.py
@src/bsa/agents/human/scripted_human.py
@src/bsa/envs/virtualhome/env.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VirtualHome task programs library</name>
  <files>src/bsa/envs/virtualhome/tasks.py</files>
  <action>
    Create `src/bsa/envs/virtualhome/tasks.py` with VirtualHome-specific task definitions. 
    
    Define tasks similar to GridHouse tasks but adapted for VirtualHome scenes:
    - "prepare_meal": Critical objects (knife, plate, ingredients), goal locations (kitchen)
    - "set_table": Critical objects (plate, fork, knife), goal locations (dining room)
    - "pack_bag": Critical objects (book, keys), goal locations (bedroom or entryway)
    - "find_keys": Critical objects (keys), goal locations (various rooms)
    
    Each task should specify:
    - task_id: str
    - name: str
    - description: str
    - critical_objects: List[str] (object IDs that exist in VirtualHome scenes)
    - goal_locations: Dict[str, str] (object_id -> room_id or container_id where object should be placed)
    
    Include helper functions:
    - `get_task(task_id: str) -> Task`: Get task by ID
    - `list_tasks() -> List[str]`: List all task IDs
    
    Use VirtualHome scene object names (may differ from GridHouse - research actual VirtualHome object names). Ensure object IDs match what VirtualHomeEnvironment can query.
    
    Reference GridHouse tasks.py structure but adapt for VirtualHome's scene structure and object naming.
  </action>
  <verify>
    Run `python -c "from src.bsa.envs.virtualhome.tasks import get_task, list_tasks; print(list_tasks()); t = get_task('prepare_meal'); print(t.critical_objects)"` - should list tasks and return task details.
  </verify>
  <done>Task programs library exists, tasks defined with VirtualHome-compatible object names, helper functions work</done>
</task>

<task type="auto">
  <name>Task 2: Create VirtualHomeEpisodeGenerator class</name>
  <files>src/bsa/envs/virtualhome/episode_generator.py, src/bsa/envs/virtualhome/__init__.py</files>
  <action>
    Create `VirtualHomeEpisodeGenerator` class in `src/bsa/envs/virtualhome/episode_generator.py` that mirrors `GridHouseEpisodeGenerator` functionality.
    
    The class should:
    - Initialize with `VirtualHomeEnvironment` instance, seed, tau_range, occlusion_severity, drift_probability
    - Implement `generate_episode()` method that:
      1. Resets environment with seed
      2. Selects goal (randomly or specified)
      3. Selects intervention parameters (tau, intervention_type)
      4. Initializes ScriptedHumanAgent with goal and initial beliefs
      5. Runs episode loop:
         - Gets human observation from environment
         - Applies intervention at timestep tau (if specified)
         - Human agent plans action based on observation and belief state
         - Executes action in environment
         - Updates human belief state based on observation (only for visible objects)
         - Records episode step with all information
      6. Returns Episode object
    
    Implement `_apply_intervention()` method that:
    - Moves a critical object to a new location when human is not observing
    - Does NOT update human's belief state (creates false belief)
    - Ensures human agent is in different room or cannot see the intervention
    
    Implement `generate_episodes()` method for batch generation (similar to GridHouse).
    
    Use VirtualHomeEnvironment methods (reset, step, get_visible_state, get_object_locations) to interact with VirtualHome.
    
    Export `VirtualHomeEpisodeGenerator` from `src/bsa/envs/virtualhome/__init__.py`.
    
    Ensure episode structure matches GridHouse episodes (same EpisodeStep and Episode dataclasses) for compatibility.
  </action>
  <verify>
    Run `python -c "from src.bsa.envs.virtualhome import VirtualHomeEnvironment, VirtualHomeEpisodeGenerator; env = VirtualHomeEnvironment(); gen = VirtualHomeEpisodeGenerator(env, seed=42); episode = gen.generate_episode(); print(f'Episode: {len(episode.steps)} steps')"` - should generate episode without errors.
  </verify>
  <done>VirtualHomeEpisodeGenerator exists, can generate episodes with false-belief interventions, integrates with ScriptedHumanAgent</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Task programs library exists with VirtualHome-compatible tasks
- [ ] VirtualHomeEpisodeGenerator can generate episodes
- [ ] Episodes include false-belief interventions at correct timesteps
- [ ] Human agent beliefs are tracked correctly (updated only for visible objects)
- [ ] Episode structure matches GridHouse episodes (compatible with Episode dataclass)
</verification>

<success_criteria>

- Task programs library created with VirtualHome-specific tasks
- VirtualHomeEpisodeGenerator generates episodes successfully
- False-belief interventions work correctly
- Human agent integration works
- Ready for Plan 03-03 (Recorder and enhanced observability)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-virtualhome-backend/03-02-SUMMARY.md`:

# Phase 3 Plan 2: VirtualHome Task Programs & Episode Generator Summary

**Implemented VirtualHome task programs library and episode generator**

## Accomplishments

- Created VirtualHome task programs library with scene-compatible tasks
- Implemented VirtualHomeEpisodeGenerator for episode generation
- False-belief intervention logic implemented
- Integration with ScriptedHumanAgent working

## Files Created/Modified

- `src/bsa/envs/virtualhome/tasks.py` - Task programs library
- `src/bsa/envs/virtualhome/episode_generator.py` - VirtualHomeEpisodeGenerator class
- `src/bsa/envs/virtualhome/__init__.py` - Export new classes

## Decisions Made

- VirtualHome object names and scene structure mapping
- How to implement false-belief interventions in VirtualHome (room-based occlusion)
- Episode structure compatibility with GridHouse episodes

## Issues Encountered

[Any issues with VirtualHome API, object naming, scene structure, etc.]

## Next Step

Ready for 03-03-PLAN.md (Recorder and enhanced observability module)
</output>
