---
phase: 01-core-interfaces-gridhouse
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [src/bsa/envs/gridhouse/episode_generator.py]
---

<objective>
Complete episode generator core logic: implement belief update mechanism and false-belief intervention application.

Purpose: The episode generator must correctly apply interventions (moving objects while human cannot see) and track how human beliefs diverge from true state, creating the false-belief scenarios needed for research.

Output: Fully functional episode generator that produces episodes with false-belief interventions and accurate belief tracking.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-interfaces-gridhouse/01-01-SUMMARY.md
@src/bsa/common/types.py
@src/bsa/envs/gridhouse/env.py
@src/bsa/envs/gridhouse/tasks.py
@src/bsa/envs/gridhouse/episode_generator.py
@src/bsa/agents/human/scripted_human.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement false-belief intervention application</name>
  <files>src/bsa/envs/gridhouse/episode_generator.py</files>
  <action>
Complete _apply_intervention method in GridHouseEpisodeGenerator:
- Check if human agent is in same room as critical object
- If human NOT in room (occlusion), move object to different location:
  - Select alternative container/room (different from current)
  - Update env.object_locations to new location
  - Update container contents if moving to/from container
  - Record intervention details (object_id, old_location, new_location)
- Ensure human belief state is NOT updated (this creates false belief)
- Handle edge cases: object already moved, no alternative locations

The intervention should:
- Only occur when human cannot see (different room or beyond visibility radius)
- Move object to plausible alternative location
- Preserve object state (if in container, move to different container)
- Create false belief: human still believes object at old location

Use env methods to check human position and visibility. Update object_locations dict directly.
</action>
  <verify>python -c "from src.bsa.envs.gridhouse import GridHouseEnvironment, GridHouseEpisodeGenerator; env = GridHouseEnvironment(seed=42); gen = GridHouseEpisodeGenerator(env, seed=42); ep = gen.generate_episode(goal_id='prepare_meal', tau=5, intervention_type='relocate'); step_before = ep.steps[4]; step_after = ep.steps[5]; print(f'Before: {step_before.true_object_locations.get(\"knife\")}'); print(f'After: {step_after.true_object_locations.get(\"knife\")}')"</verify>
  <done>Intervention moves objects when human cannot see, human beliefs remain unchanged, false belief created</done>
</task>

<task type="auto">
  <name>Task 2: Implement belief update logic with partial observability</name>
  <files>src/bsa/envs/gridhouse/episode_generator.py</files>
  <action>
Complete _update_human_belief method (or ensure ScriptedHumanAgent.update_belief is called correctly):
- Update human_belief_locations dict based on observation
- Only update beliefs for objects that are visible in observation
- When object is visible:
  - Update belief to match true location (from env.get_object_locations())
  - Handle container visibility (object visible only if container is open)
- When object is NOT visible:
  - Do NOT update belief (maintains false belief if intervention occurred)
- Track which objects human has observed vs not observed

Ensure belief updates happen correctly:
- Before intervention: beliefs match true state
- After intervention (if human didn't see): beliefs diverge from true state
- When human observes moved object: beliefs update to true state

The episode generator should call agent.update_belief() with current observation, then sync human_belief_locations dict with agent's internal state.
</action>
  <verify>python -c "from src.bsa.envs.gridhouse import GridHouseEnvironment, GridHouseEpisodeGenerator; env = GridHouseEnvironment(seed=42); gen = GridHouseEpisodeGenerator(env, seed=42); ep = gen.generate_episode(goal_id='find_keys', tau=8, intervention_type='relocate'); step = ep.steps[10]; true_loc = step.true_object_locations.get('keys'); belief_loc = step.human_belief_object_locations.get('keys'); print(f'True: {true_loc}, Belief: {belief_loc}'); print(f'False belief: {true_loc != belief_loc}')"</verify>
  <done>Belief updates occur only when objects are observed, false beliefs persist when objects not visible</done>
</task>

<task type="auto">
  <name>Task 3: Add episode validation and error handling</name>
  <files>src/bsa/envs/gridhouse/episode_generator.py</files>
  <action>
Add validation and error handling to generate_episode:
- Validate that intervention occurred at correct timestep (tau)
- Validate that human beliefs diverge after intervention (if intervention_type == 'relocate')
- Check that episode has minimum steps (at least tau + 5 steps)
- Handle edge cases:
  - No critical objects for task
  - All objects already at goal locations
  - Human completes task before intervention
  - Max steps reached before task completion

Add logging for debugging:
- Log when intervention occurs
- Log belief divergence (true vs believed location)
- Log task completion status

Ensure episode metadata includes:
- Whether intervention was applied
- Whether false belief was created
- Task completion status
- Number of steps

Test with various tau values and intervention types.
</action>
  <verify>python -c "from src.bsa.envs.gridhouse import GridHouseEnvironment, GridHouseEpisodeGenerator; env = GridHouseEnvironment(seed=42); gen = GridHouseEpisodeGenerator(env, seed=42); ep = gen.generate_episode(goal_id='prepare_meal', tau=10, intervention_type='relocate'); print(f'Episode ID: {ep.episode_id}'); print(f'Steps: {len(ep.steps)}'); print(f'Tau: {ep.tau}'); print(f'Intervention: {ep.intervention_type}'); assert ep.tau == 10, 'Tau mismatch'"</verify>
  <done>Episode validation added, error handling for edge cases, metadata includes intervention details</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Episode generator produces valid episodes with interventions
- [ ] False beliefs are created correctly (belief != true after intervention)
- [ ] Beliefs update correctly when objects are observed
- [ ] Episodes have correct metadata
- [ ] No errors with various tau values and tasks
</verification>

<success_criteria>

- Intervention application implemented correctly
- Belief update logic respects partial observability
- False beliefs created when objects move unseen
- Episodes validated and error handling added
- All edge cases handled gracefully

</success_criteria>

<output>
After completion, create `.planning/phases/01-core-interfaces-gridhouse/01-02-SUMMARY.md`:

# Phase 1 Plan 2: Episode Generator Core Logic Summary

**Completed episode generator with false-belief interventions and belief tracking**

## Accomplishments

- Implemented false-belief intervention application (move objects when human cannot see)
- Implemented belief update logic with partial observability constraints
- Added episode validation and error handling
- Episodes correctly create false-belief scenarios

## Files Created/Modified

- `src/bsa/envs/gridhouse/episode_generator.py` - Complete intervention and belief update logic

## Decisions Made

- Interventions only occur when human is in different room (simple occlusion model)
- Beliefs update only when objects are visible (enables false beliefs)
- Episode validation ensures data quality for research

## Issues Encountered

None

## Next Step

Ready for 01-03-PLAN.md (Episode serialization: Parquet/JSONL)

</output>
