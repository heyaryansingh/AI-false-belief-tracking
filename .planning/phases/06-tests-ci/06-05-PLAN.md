---
phase: 06-tests-ci
plan: 05
type: execute
depends_on: ["06-04"]
files_modified: [.github/workflows/ci.yml, .github/workflows/test.yml, Makefile]
domain: yaml/python
---

<objective>
Complete CI workflow with comprehensive testing, coverage reporting, and VirtualHome verification.

Purpose: Ensure CI runs all tests, reports coverage, verifies VirtualHome installation, and runs minimal reproduction. This completes the CI/CD pipeline and ensures code quality.

Output: Complete CI workflows that run tests, report coverage, verify VirtualHome, and run minimal reproduction.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-tests-ci/06-04-SUMMARY.md
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Enhance `.github/workflows/ci.yml` to:
    
    1. **Add coverage reporting**:
       - Run pytest with coverage
       - Upload coverage reports to GitHub Actions artifacts
       - Optionally integrate with coverage service (Codecov, Coveralls)
    
    2. **Add test matrix**:
       - Test on Python 3.9, 3.10, 3.11
       - Test with and without VirtualHome (if possible)
       - Test on multiple OS (Ubuntu, Windows, macOS if needed)
    
    3. **Add VirtualHome verification**:
       - Separate job for VirtualHome installation verification
       - Run VirtualHome-specific tests
       - Handle VirtualHome installation failures gracefully
    
    4. **Add minimal reproduction**:
       - Run `bsa reproduce --small` in CI
       - Verify all outputs are generated
       - Check that report is created
    
    5. **Add linting and type checking**:
       - Run ruff linting
       - Run mypy type checking
       - Fail on linting errors (or warnings, as configured)
    
    6. **Add test result reporting**:
       - Publish test results
       - Show test summary in CI output
    
    7. **Add caching**:
       - Cache pip dependencies
       - Cache virtual environment (if used)
    
    Ensure CI workflow is robust and handles failures gracefully.
  </action>
  <verify>
    Check `.github/workflows/ci.yml` has all required steps.
    Verify workflow syntax is correct (can use GitHub Actions validator).
  </verify>
  <done>CI workflow enhanced with coverage, VirtualHome verification, and minimal reproduction</done>
</task>

<task type="auto">
  <name>Task 2: Create VirtualHome verification workflow</name>
  <files>.github/workflows/virtualhome.yml</files>
  <action>
    Create `.github/workflows/virtualhome.yml` for VirtualHome-specific verification:
    
    1. **VirtualHome installation**:
       - Install VirtualHome dependencies
       - Verify installation succeeds
       - Handle installation failures gracefully
    
    2. **VirtualHome tests**:
       - Run VirtualHome-specific tests
       - Run VirtualHome integration tests
       - Verify VirtualHome components work
    
    3. **VirtualHome reproduction**:
       - Run minimal reproduction with VirtualHome
       - Verify VirtualHome episodes can be generated
       - Verify VirtualHome experiments can be run
    
    4. Make this workflow optional (not blocking):
       - Use `continue-on-error: true` if VirtualHome installation fails
       - Document that VirtualHome is optional
    
    This workflow ensures VirtualHome works when available but doesn't block CI if it fails.
  </action>
  <verify>
    Check `.github/workflows/virtualhome.yml` exists and has correct structure.
    Verify workflow handles VirtualHome installation failures gracefully.
  </verify>
  <done>VirtualHome verification workflow created</done>
</task>

<task type="auto">
  <name>Task 3: Update Makefile test targets</name>
  <files>Makefile</files>
  <action>
    Update `Makefile` to add comprehensive test targets:
    
    1. **Add test targets**:
       - `test-unit`: Run unit tests only
       - `test-integration`: Run integration tests only
       - `test-coverage`: Run tests with coverage report
       - `test-fast`: Run fast tests (skip slow integration tests)
       - `test-all`: Run all tests
    
    2. **Add coverage targets**:
       - `coverage`: Generate coverage report
       - `coverage-html`: Generate HTML coverage report
       - `coverage-report`: Show coverage summary
    
    3. **Add linting targets**:
       - `lint`: Run ruff linting
       - `type-check`: Run mypy type checking
       - `format`: Run black formatting (if used)
       - `format-check`: Check formatting without modifying
    
    4. **Add CI targets**:
       - `ci-test`: Run tests as in CI
       - `ci-lint`: Run linting as in CI
       - `ci-reproduce`: Run minimal reproduction as in CI
    
    Ensure targets match CI workflow steps.
  </action>
  <verify>
    Run `make test-unit` - should run unit tests.
    Run `make test-coverage` - should generate coverage report.
    Run `make lint` - should run linting.
  </verify>
  <done>Makefile updated with comprehensive test targets</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CI workflow enhanced with all required steps
- [ ] VirtualHome verification workflow created
- [ ] Makefile test targets work
- [ ] CI workflow syntax is correct
- [ ] Coverage reporting works
- [ ] Minimal reproduction works in CI
</verification>

<success_criteria>

- Complete CI workflow with testing, coverage, and reproduction
- VirtualHome verification workflow (optional, non-blocking)
- Makefile test targets complete
- CI/CD pipeline fully functional
- Phase 6 complete - comprehensive test suite and CI verification ready
  </success_criteria>

<output>
After completion, create `.planning/phases/06-tests-ci/06-05-SUMMARY.md`:

# Phase 6 Plan 5: CI Workflow Completion Summary

**Completed CI workflow with comprehensive testing and verification**

## Accomplishments

- Enhanced CI workflow with coverage reporting
- Created VirtualHome verification workflow
- Updated Makefile with comprehensive test targets
- CI/CD pipeline fully functional

## Files Created/Modified

- `.github/workflows/ci.yml` - Enhanced CI workflow
- `.github/workflows/virtualhome.yml` - VirtualHome verification workflow
- `Makefile` - Updated test targets

## Decisions Made

- CI matrix: Python 3.9, 3.10, 3.11
- Coverage: Report coverage, optionally integrate with coverage service
- VirtualHome: Optional workflow, non-blocking
- Test targets: Separate targets for unit, integration, coverage tests

## Issues Encountered

[Any issues with CI workflow, VirtualHome installation, etc.]

## Next Step

**Phase 6 complete!** Comprehensive test suite and CI verification ready.
</output>
