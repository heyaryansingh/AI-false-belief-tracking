---
phase: 04-experiment-harness
plan: 05
type: execute
depends_on: ["04-04"]
files_modified: [src/bsa/cli.py, src/bsa/experiments/run_experiment.py, scripts/reproduce.py]
domain: python
---

<objective>
Complete CLI commands and implement full reproduction pipeline.

Purpose: Complete all CLI commands (generate, run, analyze, reproduce, sweep) and implement the full reproduction pipeline (`make reproduce`). This ensures the experiment harness is fully functional and ready for use.

Output: Complete CLI implementation, full reproduction pipeline working, all commands tested.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-experiment-harness/04-04-SUMMARY.md
@src/bsa/cli.py
@src/bsa/experiments/run_experiment.py
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete reproduce() function</name>
  <files>src/bsa/experiments/run_experiment.py</files>
  <action>
    Implement `reproduce()` function in `src/bsa/experiments/run_experiment.py`:
    
    1. Takes `small` parameter (for CI/testing with small dataset)
    2. Full reproduction pipeline:
       - Generate episodes (small dataset if `small=True`)
       - Run experiments with all models and conditions
       - Generate manifests
       - Save results
    3. Uses default configs:
       - Generator: `configs/generator/default.yaml`
       - Experiments: `configs/experiments/exp_main.yaml`
    4. If `small=True`:
       - Reduces num_episodes (e.g., 10 instead of 100)
       - Reduces num_runs (e.g., 2 instead of 10)
       - Uses faster settings
    
    5. Prints progress and completion message
    6. Returns success status
    
    Ensure reproduction is deterministic (uses seeds).
  </action>
  <verify>
    Run `python -m src.bsa.cli reproduce --small` - should run full reproduction pipeline with small dataset.
    Run `python -c "from src.bsa.experiments.run_experiment import reproduce; reproduce(small=True)"` - should complete without errors.
  </verify>
  <done>reproduce() function implemented, full pipeline works</done>
</task>

<task type="auto">
  <name>Task 2: Complete CLI command implementations</name>
  <files>src/bsa/cli.py, src/bsa/experiments/run_experiment.py</files>
  <action>
    Ensure all CLI commands are fully implemented:
    
    1. `generate` command:
       - Loads generator config
       - Generates episodes
       - Saves to output directory
       - Prints progress
    
    2. `run` command:
       - Loads experiment config
       - Runs experiments
       - Saves results and manifests
       - Prints progress
    
    3. `analyze` command:
       - Loads analysis config
       - Analyzes results (will be implemented in Phase 5)
       - For now, prints message that analysis is pending
    
    4. `reproduce` command:
       - Runs full pipeline
       - Uses `reproduce()` function
    
    5. `sweep` command:
       - Loads sweep config
       - Runs sweep
       - Saves results
    
    Ensure all commands have proper error handling and progress output.
  </action>
  <verify>
    Run `python -m src.bsa.cli --help` - should show all commands.
    Run each command with `--help` to verify help messages work.
    Run `python -m src.bsa.cli generate --config configs/generator/default.yaml --output data/episodes/test` - should generate episodes.
  </verify>
  <done>All CLI commands implemented and working</done>
</task>

<task type="auto">
  <name>Task 3: Create standalone reproduction script</name>
  <files>scripts/reproduce.py</files>
  <action>
    Create `scripts/reproduce.py` script that:
    
    1. Can be run standalone: `python scripts/reproduce.py [--small]`
    2. Calls `reproduce()` function from `src/bsa.experiments.run_experiment`
    3. Handles command-line arguments (--small flag)
    4. Provides clear output and error messages
    
    This enables `make reproduce` to work correctly.
    
    Ensure script works both as standalone and when called from Makefile.
  </action>
  <verify>
    Run `python scripts/reproduce.py --help` - should show help message.
    Run `python scripts/reproduce.py --small` - should run reproduction pipeline.
  </verify>
  <done>Standalone reproduction script exists, works with Makefile</done>
</task>

<task type="auto">
  <name>Task 4: Update Makefile targets</name>
  <files>Makefile</files>
  <action>
    Update Makefile to ensure all targets work correctly:
    
    1. `generate` target: Calls `bsa generate` with correct config
    2. `run` target: Calls `bsa run` with correct config
    3. `analyze` target: Calls `bsa analyze` with correct config (may be stubbed until Phase 5)
    4. `reproduce` target: Calls `python scripts/reproduce.py` or `bsa reproduce`
    
    Ensure all targets work and provide clear output.
  </action>
  <verify>
    Run `make generate` - should generate episodes.
    Run `make run` - should run experiments (may take time).
    Run `make reproduce` - should run full pipeline.
  </verify>
  <done>Makefile targets updated, all work correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] reproduce() function implemented and works
- [ ] All CLI commands work correctly
- [ ] Standalone reproduction script works
- [ ] Makefile targets work
- [ ] Full reproduction pipeline completes successfully
- [ ] Small dataset mode works for CI/testing
</verification>

<success_criteria>

- Full reproduction pipeline implemented and working
- All CLI commands complete and functional
- Makefile targets work correctly
- Small dataset mode works for CI
- Phase 4 complete - Experiment harness ready
  </success_criteria>

<output>
After completion, create `.planning/phases/04-experiment-harness/04-05-SUMMARY.md`:

# Phase 4 Plan 5: CLI Completion & Integration Summary

**Completed CLI implementation and full reproduction pipeline**

## Accomplishments

- Completed reproduce() function with full pipeline
- All CLI commands implemented and working
- Standalone reproduction script created
- Makefile targets updated and working
- Small dataset mode for CI/testing

## Files Created/Modified

- `src/bsa/experiments/run_experiment.py` - Completed reproduce() function
- `src/bsa/cli.py` - All commands implemented
- `scripts/reproduce.py` - Standalone reproduction script
- `Makefile` - Updated targets

## Decisions Made

- Reproduction pipeline structure (generate → run → analyze)
- Small dataset parameters (num_episodes=10, num_runs=2)
- CLI command structure and error handling
- Makefile integration approach

## Issues Encountered

[Any issues with CLI implementation, reproduction pipeline, etc.]

## Next Step

**Phase 4 complete!** Ready for Phase 5 (Metrics + Analysis + Report) or Phase 6 (Tests + CI).
</output>
