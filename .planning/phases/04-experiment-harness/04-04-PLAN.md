---
phase: 04-experiment-harness
plan: 04
type: execute
depends_on: ["04-03"]
files_modified: [src/bsa/experiments/manifest.py, src/bsa/experiments/runner.py, scripts/generate_manifest.py]
domain: python
---

<objective>
Implement reproducibility infrastructure with manifest generation (git hash, config hash, versions).

Purpose: Ensure experiments are fully reproducible by tracking git commit hash, config file hashes, Python package versions, and other environment information. This enables exact reproduction of results.

Output: Manifest generation system that creates manifests for experiments, tracks all dependencies, and enables reproducibility verification.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-experiment-harness/04-03-SUMMARY.md
@src/bsa/experiments/runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manifest generation module</name>
  <files>src/bsa/experiments/manifest.py, src/bsa/experiments/__init__.py</files>
  <action>
    Create `src/bsa/experiments/manifest.py` with manifest generation functions:
    
    1. `generate_manifest()` function that creates experiment manifest:
       - Git commit hash (using `git rev-parse HEAD`)
       - Git branch name
       - Git status (clean/dirty)
       - Config file hash (SHA256 of config file contents)
       - Python version
       - Package versions (from requirements.txt or pip freeze)
       - System information (OS, CPU, etc.)
       - Experiment metadata (name, timestamp, seed, etc.)
       - Returns manifest dictionary
    
    2. `save_manifest()` function that saves manifest to JSON file:
       - Saves to `results/manifests/{experiment_name}/manifest.json`
       - Includes all manifest information
       - Pretty-printed JSON for readability
    
    3. `verify_reproducibility()` function that:
       - Loads manifest from previous experiment
       - Compares current environment to manifest
       - Reports differences (git hash, package versions, etc.)
       - Returns verification report
    
    4. Handle edge cases:
       - Git not available (skip git info)
       - Config file not found (skip config hash)
       - Package versions unavailable (skip package info)
    
    Export functions from `src/bsa/experiments/__init__.py`.
    
    Ensure manifest generation is deterministic and handles all edge cases gracefully.
  </action>
  <verify>
    Run `python -c "from src.bsa.experiments import generate_manifest; manifest = generate_manifest({'name': 'test', 'seed': 42}); print(f'Manifest keys: {list(manifest.keys())}')"` - should generate manifest with expected keys.
    Run `python -c "from src.bsa.experiments import save_manifest; save_manifest({'name': 'test', 'git_hash': 'abc123'}, 'results/manifests/test/manifest.json'); print('Manifest saved')"` - should save manifest file.
  </verify>
  <done>Manifest generation module exists, can generate and save manifests, can verify reproducibility</done>
</task>

<task type="auto">
  <name>Task 2: Integrate manifest generation with ExperimentRunner</name>
  <files>src/bsa/experiments/runner.py</files>
  <action>
    Update `ExperimentRunner` to generate and save manifests:
    
    1. In `run_experiment()` method:
       - Generate manifest before running experiments
       - Include experiment config in manifest
       - Save manifest to results/manifests/{experiment_name}/
    
    2. Ensure manifest includes:
       - Experiment name and config
       - All environment information
       - Git and config hashes
    
    3. Update `_save_results()` to reference manifest location
    
    Ensure manifest is generated for every experiment run.
  </action>
  <verify>
    Run `python -c "from src.bsa.experiments import ExperimentRunner; runner = ExperimentRunner({'name': 'test', 'models': ['reactive'], 'conditions': ['control'], 'num_runs': 1, 'seed': 42}); print('Runner generates manifests')"` - should work without errors.
    Check that running an experiment creates manifest file in results/manifests/.
  </verify>
  <done>ExperimentRunner generates and saves manifests automatically</done>
</task>

<task type="auto">
  <name>Task 3: Create reproducibility verification script</name>
  <files>scripts/verify_reproducibility.py</files>
  <action>
    Create `scripts/verify_reproducibility.py` script that:
    
    1. Takes manifest file path as argument
    2. Loads manifest
    3. Compares current environment to manifest:
       - Git commit hash
       - Config file hash
       - Package versions
       - Python version
    4. Reports differences
    5. Provides recommendations for reproducibility
    
    Script should be runnable standalone: `python scripts/verify_reproducibility.py results/manifests/test/manifest.json`
    
    Output should be clear and actionable (what differs, how to reproduce).
  </action>
  <verify>
    Run `python scripts/verify_reproducibility.py --help` - should show help message.
    Run `python scripts/verify_reproducibility.py results/manifests/test/manifest.json` - should verify reproducibility (if manifest exists).
  </verify>
  <done>Reproducibility verification script exists, can verify experiments</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Manifest generation works
- [ ] Git hash captured correctly
- [ ] Config hash computed correctly
- [ ] Package versions captured
- [ ] Manifests saved to results/manifests/
- [ ] ExperimentRunner generates manifests automatically
- [ ] Reproducibility verification script works
</verification>

<success_criteria>

- Manifest generation implemented and working
- Manifests include all required information (git hash, config hash, versions)
- ExperimentRunner generates manifests automatically
- Reproducibility verification script works
- Ready for Plan 04-05 (CLI completion)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-experiment-harness/04-04-SUMMARY.md`:

# Phase 4 Plan 4: Reproducibility & Manifests Summary

**Implemented reproducibility infrastructure with manifest generation**

## Accomplishments

- Created manifest generation module
- Manifests include git hash, config hash, package versions
- ExperimentRunner generates manifests automatically
- Reproducibility verification script created

## Files Created/Modified

- `src/bsa/experiments/manifest.py` - Manifest generation functions
- `src/bsa/experiments/runner.py` - Integrated manifest generation
- `src/bsa/experiments/__init__.py` - Export manifest functions
- `scripts/verify_reproducibility.py` - Reproducibility verification script

## Decisions Made

- Manifest format (JSON with git hash, config hash, versions)
- How to compute config hash (SHA256 of file contents)
- How to capture package versions (pip freeze or requirements.txt)
- Manifest storage location (results/manifests/{experiment_name}/)
- Reproducibility verification approach

## Issues Encountered

[Any issues with git hash capture, config hashing, package version detection, etc.]

## Next Step

Ready for 04-05-PLAN.md (CLI completion and integration)
</output>
