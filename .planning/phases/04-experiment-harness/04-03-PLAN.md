---
phase: 04-experiment-harness
plan: 03
type: execute
depends_on: ["04-02"]
files_modified: [src/bsa/experiments/sweep.py, src/bsa/experiments/__init__.py, configs/experiments/]
domain: python
---

<objective>
Create sweep runner for parameter ablations and hyperparameter searches.

Purpose: Enable automated parameter sweeps (e.g., num_particles, intervention_threshold) to study how different hyperparameters affect helper agent performance. This enables ablation studies and hyperparameter optimization.

Output: SweepRunner class that can run parameter sweeps, collect results, and save ablation results.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-experiment-harness/04-02-SUMMARY.md
@src/bsa/experiments/runner.py
@src/bsa/experiments/evaluator.py
@configs/models/belief_pf.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SweepRunner class</name>
  <files>src/bsa/experiments/sweep.py, src/bsa/experiments/__init__.py</files>
  <action>
    Create `src/bsa/experiments/sweep.py` with `SweepRunner` class that:
    
    1. Initializes with sweep configuration:
       - Parameter to sweep (e.g., num_particles, intervention_threshold)
       - Parameter values to test (list or range)
       - Base experiment config
       - Output directory
    
    2. Implements `run_sweep()` method that:
       - For each parameter value:
         - Creates modified experiment config with parameter value
         - Runs experiment using ExperimentRunner
         - Collects results
       - Aggregates results across parameter values
       - Saves sweep results to output directory
    
    3. Implements `_create_sweep_configs()` method that:
       - Takes base config and parameter sweep definition
       - Generates list of configs, one per parameter value
       - Handles nested configs (e.g., model.particle_filter.num_particles)
    
    4. Implements `_aggregate_sweep_results()` method that:
       - Aggregates metrics across parameter values
       - Computes statistics (mean, std, min, max) for each metric
       - Returns aggregated results
    
    5. Supports multiple parameter sweeps (grid search):
       - Can sweep multiple parameters simultaneously
       - Generates cartesian product of parameter values
    
    Export `SweepRunner` from `src/bsa/experiments/__init__.py`.
    
    Ensure sweep results are saved in a structured format (Parquet + JSON) for easy analysis.
  </action>
  <verify>
    Run `python -c "from src.bsa.experiments import SweepRunner; print('Import OK')"` - should import successfully.
    Run `python -c "from src.bsa.experiments.sweep import SweepRunner; sweep = SweepRunner({'parameter': 'num_particles', 'values': [10, 50, 100], 'base_config': {'models': ['belief_pf'], 'conditions': ['false_belief'], 'num_runs': 1, 'seed': 42}}); print('SweepRunner created')"` - should create sweep runner without errors.
  </verify>
  <done>SweepRunner exists, can run parameter sweeps, aggregates results</done>
</task>

<task type="auto">
  <name>Task 2: Create sweep config files</name>
  <files>configs/experiments/sweep_particles.yaml, configs/experiments/sweep_intervention.yaml</files>
  <action>
    Create example sweep config files:
    
    1. `configs/experiments/sweep_particles.yaml`: Sweep num_particles for belief-sensitive helper
       - Parameter: model.belief_pf.particle_filter.num_particles
       - Values: [10, 50, 100, 200]
       - Base config: exp_main.yaml
    
    2. `configs/experiments/sweep_intervention.yaml`: Sweep intervention_threshold
       - Parameter: model.belief_pf.intervention.threshold
       - Values: [0.5, 0.6, 0.7, 0.8, 0.9]
       - Base config: exp_main.yaml
    
    These configs demonstrate how to set up parameter sweeps.
  </action>
  <verify>
    Run `python -c "import yaml; from pathlib import Path; config = yaml.safe_load(open('configs/experiments/sweep_particles.yaml')); print('Config valid')"` - should load config without errors.
  </verify>
  <done>Sweep config files created, demonstrate parameter sweep setup</done>
</task>

<task type="auto">
  <name>Task 3: Integrate SweepRunner with CLI</name>
  <files>src/bsa/cli.py, src/bsa/experiments/run_experiment.py</files>
  <action>
    Add sweep command to CLI:
    
    1. Update `src/bsa/cli.py` to add `sweep` subcommand:
       - `bsa sweep --config <sweep_config.yaml> --output <output_dir>`
       - Loads sweep config
       - Runs sweep using SweepRunner
       - Saves results
    
    2. Update `src/bsa/experiments/run_experiment.py` to add `run_sweep()` function:
       - Loads sweep config
       - Creates SweepRunner
       - Runs sweep
       - Saves results
    
    Ensure sweep command works with config files in `configs/experiments/`.
  </action>
  <verify>
    Run `python -m src.bsa.cli sweep --help` - should show sweep command help.
    Run `python -m src.bsa.cli sweep --config configs/experiments/sweep_particles.yaml --output results/sweep_test` - should run sweep (may take time).
  </verify>
  <done>Sweep command added to CLI, integrates with SweepRunner</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SweepRunner can run parameter sweeps
- [ ] Can sweep single parameter
- [ ] Can sweep multiple parameters (grid search)
- [ ] Results aggregated correctly
- [ ] Sweep config files work
- [ ] CLI sweep command works
</verification>

<success_criteria>

- SweepRunner implemented and working
- Can run parameter sweeps for ablations
- Results aggregated and saved correctly
- CLI integration works
- Ready for Plan 04-04 (Reproducibility and manifests)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-experiment-harness/04-03-SUMMARY.md`:

# Phase 4 Plan 3: Sweep Runner & Ablations Summary

**Implemented sweep runner for parameter ablations**

## Accomplishments

- Created SweepRunner class for parameter sweeps
- Supports single and multiple parameter sweeps (grid search)
- Results aggregation across parameter values
- Sweep config files created
- CLI integration working

## Files Created/Modified

- `src/bsa/experiments/sweep.py` - SweepRunner class
- `src/bsa/experiments/run_experiment.py` - Added run_sweep() function
- `src/bsa/experiments/__init__.py` - Export SweepRunner
- `src/bsa/cli.py` - Added sweep command
- `configs/experiments/sweep_particles.yaml` - Example sweep config
- `configs/experiments/sweep_intervention.yaml` - Example sweep config

## Decisions Made

- Sweep configuration format (parameter paths, value lists)
- How to handle nested configs (model.particle_filter.num_particles)
- Results aggregation approach (mean, std, min, max)
- Grid search implementation (cartesian product)

## Issues Encountered

[Any issues with parameter sweeping, config handling, etc.]

## Next Step

Ready for 04-04-PLAN.md (Reproducibility and manifests)
</output>
