---
phase: 02-helper-models
plan: 04
type: execute
depends_on: ["02-03"]
files_modified: [src/bsa/inference/particle_filter.py, src/bsa/inference/likelihood.py, src/bsa/inference/__init__.py]
domain: python
---

<objective>
Implement particle filter for belief tracking and likelihood models for action-to-belief inference.

Purpose: Create the core inference machinery for belief-sensitive helper. Particle filter maintains distribution over (goal, object locations) representing human's belief state. Likelihood models compute P(action | goal, believed_locations) for particle weighting.
Output: ParticleFilter class for online belief tracking and LikelihoodModel interface with rule-based implementation.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/bsa/common/types.py
@src/bsa/inference/goal.py
@src/bsa/envs/gridhouse/tasks.py
@src/bsa/agents/human/policies.py
@.planning/phases/02-helper-models/02-03-SUMMARY.md

**Established patterns:**
- Goal inference from Plan 02-03
- Task definitions and human agent policies show action patterns
- Type hints and docstrings throughout

**Key decisions:**
- Particle filter tracks (goal, object_locations) pairs
- Likelihood models compute P(action | goal, believed_locations)
- Rule-based likelihood models (sufficient for research)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create likelihood model interface and rule-based implementation</name>
  <files>src/bsa/inference/likelihood.py</files>
  <action>
Create likelihood model module in `src/bsa/inference/likelihood.py`:

1. **LikelihoodModel abstract base class:**
   - Abstract method: `compute(action: Action, goal: Task, believed_locations: Dict[str, ObjectLocation], observation: Observation) -> float`
   - Returns: P(action | goal, believed_locations, observation)
   - Type hints and docstrings

2. **RuleBasedLikelihoodModel class:**
   - Implements LikelihoodModel
   - Rule-based heuristic for P(action | goal, believed_locations):
     - Actions that make progress towards goal given believed locations → high likelihood
     - Actions inconsistent with goal → low likelihood
     - Actions that would be taken if human believes locations → high likelihood
     - Use similar logic to human agent policies but evaluate against believed locations
   - Examples:
     - Moving towards believed location of critical object → high likelihood
     - Picking up critical object at believed location → high likelihood
     - Moving away from believed locations → low likelihood
     - Opening container containing critical object → high likelihood
   - Return normalized probability (0-1 range)

3. **Design considerations:**
   - Likelihood should be higher when action is consistent with goal and believed state
   - Use distance-based heuristics similar to human agent policies
   - Handle edge cases (no believed location, object not in belief state, etc.)
   - Can be extended with learned models later
  </action>
  <verify>python -c "from src.bsa.inference.likelihood import RuleBasedLikelihoodModel, LikelihoodModel; from src.bsa.common.types import Action; from src.bsa.envs.gridhouse.tasks import get_task; model = RuleBasedLikelihoodModel(); assert isinstance(model, LikelihoodModel); print('Likelihood model created successfully')"</verify>
  <done>LikelihoodModel abstract class and RuleBasedLikelihoodModel implementation exist, compute method returns valid probabilities, no errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement particle filter for belief tracking</name>
  <files>src/bsa/inference/particle_filter.py, src/bsa/inference/__init__.py</files>
  <action>
Create particle filter module in `src/bsa/inference/particle_filter.py`:

1. **Particle dataclass:**
   - `goal_id: str`: Goal hypothesis
   - `object_locations: Dict[str, ObjectLocation]`: Believed object locations
   - `weight: float`: Particle weight (unnormalized)

2. **ParticleFilter class:**
   - Maintains list of particles: `List[Particle]`
   - Methods:
     - `__init__(task_list: List[Task], num_particles: int = 100, seed: Optional[int] = None)`: Initialize with uniform particles over goals and initial object locations
     - `update(human_action: Action, observation: Observation, true_locations: Dict[str, ObjectLocation], likelihood_model: LikelihoodModel, episode_step: Optional[EpisodeStep] = None) -> None`: Update particle weights using likelihood model
     - `resample() -> None`: Resample particles based on weights (systematic resampling)
     - `predict(observation: Observation) -> None`: Predict step (particle drift/noise, optional)
     - `get_belief_distribution() -> Dict[str, float]`: Return goal distribution (marginalize over object locations)
     - `get_object_location_beliefs() -> Dict[str, Dict[str, float]]`: Return object location beliefs (marginalize over goals)
     - `get_most_likely_goal() -> Optional[str]`: Return most likely goal
     - `get_most_likely_locations() -> Dict[str, ObjectLocation]`: Return most likely object locations (MAP estimate)
     - `reset() -> None`: Reset to initial uniform distribution

3. **Particle filter algorithm:**
   - **Initialization:** Uniform distribution over goals, initial object locations from observation
   - **Update (weighting):** For each particle, compute likelihood P(action | goal, believed_locations) using likelihood model, update weight
   - **Normalize:** Normalize particle weights
   - **Resample:** Systematic resampling when effective sample size is low
   - **Predict (optional):** Add noise/drift to object locations (model uncertainty)

4. **Type hints and docstrings:** Full type hints, docstrings explaining particle filter algorithm

5. **Design considerations:**
   - Use numpy for probability operations and resampling
   - Deterministic seeding for reproducibility
   - Efficient resampling (systematic resampling)
   - Handle edge cases (all weights zero, degenerate distribution, etc.)
   - Track effective sample size for resampling decisions
  </action>
  <verify>python -c "from src.bsa.inference.particle_filter import ParticleFilter; from src.bsa.envs.gridhouse.tasks import list_tasks, get_task; tasks = [get_task(t) for t in list_tasks()]; pf = ParticleFilter(tasks, num_particles=10); assert len(pf.get_belief_distribution()) == len(tasks); print('Particle filter created successfully')"</verify>
  <done>ParticleFilter class exists, can initialize particles, update weights from actions, resample, return belief distributions, no errors.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.bsa.inference.likelihood import RuleBasedLikelihoodModel"` succeeds
- [ ] `python -c "from src.bsa.inference.particle_filter import ParticleFilter"` succeeds
- [ ] LikelihoodModel.compute returns valid probabilities (0-1 range)
- [ ] ParticleFilter updates particle weights from actions
- [ ] ParticleFilter resamples correctly
- [ ] get_belief_distribution returns valid probability distributions
- [ ] Type hints and docstrings complete
</verification>

<success_criteria>

- LikelihoodModel abstract class and RuleBasedLikelihoodModel implementation exist
- ParticleFilter class implements online belief tracking
- Particle filter maintains distribution over (goal, object_locations)
- Update and resample methods work correctly
- Belief distributions can be extracted (goal distribution, object location beliefs)
- No errors on instantiation or method calls
  </success_criteria>

<output>
After completion, create `.planning/phases/02-helper-models/02-04-SUMMARY.md`:

# Phase 2 Plan 4: Particle Filter + Likelihood Models Summary

**Implemented particle filter for belief tracking and likelihood models**

## Accomplishments

- Created LikelihoodModel abstract class and RuleBasedLikelihoodModel implementation
- Implemented ParticleFilter class for online belief tracking
- Particle filter maintains distribution over (goal, object_locations)
- Update, resample, and belief extraction methods implemented

## Files Created/Modified

- `src/bsa/inference/likelihood.py` - LikelihoodModel interface and rule-based implementation
- `src/bsa/inference/particle_filter.py` - ParticleFilter class
- `src/bsa/inference/__init__.py` - Export new classes

## Decisions Made

- Rule-based likelihood model: P(action | goal, believed_locations)
- Particle filter tracks (goal, object_locations) pairs
- Systematic resampling for particle filter
- Deterministic seeding for reproducibility

## Issues Encountered

[None or list issues]

## Next Step

Ready for 02-05-PLAN.md (Belief inference module + Belief-sensitive helper + Intervention policy)
</output>
