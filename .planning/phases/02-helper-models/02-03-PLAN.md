---
phase: 02-helper-models
plan: 03
type: execute
depends_on: ["02-01"]
files_modified: [src/bsa/inference/__init__.py, src/bsa/inference/goal.py, src/bsa/agents/helper/goal_only.py, src/bsa/agents/helper/__init__.py]
domain: python
---

<objective>
Implement goal inference module and goal-only helper that infers human's goal but assumes beliefs match true state.

Purpose: Create a baseline helper that performs goal inference from human actions but doesn't track beliefs. This demonstrates the value of goal inference alone vs. full belief tracking.
Output: Goal inference module with action-to-goal likelihood models, and GoalOnlyHelper class that uses goal inference for planning.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/bsa/common/types.py
@src/bsa/agents/helper/base.py
@src/bsa/envs/gridhouse/tasks.py
@src/bsa/agents/human/policies.py
@.planning/phases/02-helper-models/02-01-SUMMARY.md

**Established patterns:**
- HelperAgent interface from Plan 02-01
- Task definitions in tasks.py
- Human agent planning policies show how goals relate to actions
- Type hints and docstrings throughout

**Key decisions:**
- Goal inference uses action-to-goal likelihood models
- Goal-only helper assumes human beliefs match true state (no belief tracking)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create goal inference module</name>
  <files>src/bsa/inference/__init__.py, src/bsa/inference/goal.py</files>
  <action>
Create goal inference module in `src/bsa/inference/goal.py`:

1. **GoalInference class:**
   - Maintains distribution over goals: `Dict[str, float]` (goal_id -> probability)
   - Methods:
     - `__init__(task_list: List[Task], prior: Optional[Dict[str, float]] = None)`: Initialize with uniform prior or custom prior
     - `update(human_action: Action, observation: Observation, episode_step: Optional[EpisodeStep] = None) -> None`: Update goal distribution based on human action
     - `get_goal_distribution() -> Dict[str, float]`: Return current goal distribution
     - `get_most_likely_goal() -> Optional[str]`: Return goal_id with highest probability
     - `reset() -> None`: Reset to initial prior

2. **Likelihood model:**
   - `_compute_action_likelihood(action: Action, goal: Task, observation: Observation) -> float`: Compute P(action | goal, observation)
   - Rule-based heuristic: Actions that make progress towards goal have higher likelihood
   - Examples:
     - Moving towards critical objects for goal → high likelihood
     - Picking up critical objects → high likelihood
     - Moving away from critical objects → low likelihood
     - Actions unrelated to goal → medium likelihood
   - Use Bayesian update: P(goal | action) ∝ P(action | goal) * P(goal)

3. **Type hints and docstrings:** Full type hints, docstrings explaining inference logic

4. **Design considerations:**
   - Rule-based likelihood model (sufficient for research, can be replaced with learned model later)
   - Normalize probabilities after updates
   - Handle edge cases (no actions yet, all probabilities zero, etc.)
   - Use numpy for probability operations if needed
  </action>
  <verify>python -c "from src.bsa.inference.goal import GoalInference; from src.bsa.envs.gridhouse.tasks import list_tasks, get_task; tasks = [get_task(t) for t in list_tasks()]; gi = GoalInference(tasks); assert len(gi.get_goal_distribution()) == len(tasks); print('Goal inference module created successfully')"</verify>
  <done>GoalInference class exists, can update goal distribution from actions, returns valid probability distributions, no errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement goal-only helper</name>
  <files>src/bsa/agents/helper/goal_only.py, src/bsa/agents/helper/__init__.py</files>
  <action>
Create `GoalOnlyHelper` class in `src/bsa/agents/helper/goal_only.py`:

1. **Class structure:**
   - Inherit from `HelperAgent`
   - Contains `GoalInference` instance
   - Assumes human beliefs match true state (no belief tracking)

2. **plan_action method:**
   - Input: `observation: Observation`, optional `episode_step: Optional[EpisodeStep]`
   - Steps:
     - Update goal inference from human action in episode_step (if available)
     - Get most likely goal from inference
     - Plan action to help with inferred goal (assume human beliefs = true state)
     - Policy: Fetch critical objects for inferred goal, place them at goal locations
   - Return: `Action` enum value

3. **update_belief method:**
   - Update goal inference distribution (not belief state)
   - Extract human_action from episode_step if available
   - Call goal_inference.update()

4. **get_belief_state method:**
   - Return goal distribution: `{"goal_distribution": goal_inference.get_goal_distribution()}`

5. **detect_false_belief method:**
   - Return `False` (goal-only helper cannot detect false beliefs, assumes beliefs match true state)

6. **Type hints and docstrings:** Full type hints, docstrings

7. **Design considerations:**
   - Uses goal inference to determine what human is trying to accomplish
   - Assumes human knows true object locations (no belief tracking)
   - Plans actions to help with inferred goal
   - Similar planning logic to reactive helper but goal-directed
  </action>
  <verify>python -c "from src.bsa.agents.helper.goal_only import GoalOnlyHelper; from src.bsa.agents.helper import HelperAgent; h = GoalOnlyHelper(); assert isinstance(h, HelperAgent); dist = h.get_belief_state(); assert 'goal_distribution' in dist; print('Goal-only helper created successfully')"</verify>
  <done>GoalOnlyHelper class exists, implements HelperAgent interface, uses GoalInference, get_belief_state returns goal distribution, plan_action returns valid Action, no errors.</done>
</task>

<task type="auto">
  <name>Task 3: Export goal-only helper from module</name>
  <files>src/bsa/agents/helper/__init__.py</files>
  <action>
Update `src/bsa/agents/helper/__init__.py` to also export `GoalOnlyHelper` from `goal_only.py`. Keep existing exports.
</action>
  <verify>python -c "from src.bsa.agents.helper import GoalOnlyHelper, ReactiveHelper, HelperAgent; print('Exports successful')"</verify>
  <done>GoalOnlyHelper can be imported from src.bsa.agents.helper module.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.bsa.inference.goal import GoalInference"` succeeds
- [ ] `python -c "from src.bsa.agents.helper import GoalOnlyHelper"` succeeds
- [ ] GoalInference updates goal distribution from actions
- [ ] GoalOnlyHelper uses goal inference for planning
- [ ] get_belief_state returns goal distribution
- [ ] Type hints and docstrings complete
</verification>

<success_criteria>

- GoalInference class implements Bayesian goal inference
- GoalOnlyHelper class implements HelperAgent interface
- Goal inference updates from human actions
- Goal-only helper plans actions based on inferred goal
- Assumes human beliefs match true state (no belief tracking)
- Exported from modules
- No errors on instantiation or method calls
  </success_criteria>

<output>
After completion, create `.planning/phases/02-helper-models/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Goal Inference + Goal-Only Helper Summary

**Implemented goal inference module and goal-only helper baseline**

## Accomplishments

- Created GoalInference class with Bayesian goal inference
- Implemented rule-based action-to-goal likelihood model
- Created GoalOnlyHelper class that infers goals but assumes beliefs match true state
- Goal-only helper plans actions based on inferred goal

## Files Created/Modified

- `src/bsa/inference/__init__.py` - Inference module exports
- `src/bsa/inference/goal.py` - GoalInference class
- `src/bsa/agents/helper/goal_only.py` - GoalOnlyHelper class
- `src/bsa/agents/helper/__init__.py` - Export GoalOnlyHelper

## Decisions Made

- Rule-based likelihood model for goal inference (P(action | goal))
- Bayesian update: P(goal | action) ∝ P(action | goal) * P(goal)
- Goal-only helper assumes human beliefs match true state
- Goal distribution returned in get_belief_state

## Issues Encountered

[None or list issues]

## Next Step

Ready for 02-04-PLAN.md (Particle filter implementation + Likelihood models)
</output>
