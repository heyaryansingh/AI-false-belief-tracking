---
phase: 02-helper-models
plan: 05
type: execute
depends_on: ["02-04"]
files_modified: [src/bsa/inference/belief.py, src/bsa/agents/helper/belief_sensitive.py, src/bsa/agents/helper/policies.py, src/bsa/agents/helper/__init__.py]
domain: python
---

<objective>
Implement belief inference module, belief-sensitive helper, and intervention policy.

Purpose: Create the main contribution - a helper that tracks human's belief state using particle filter, detects false beliefs, and intervenes appropriately. This demonstrates the value of belief-sensitive assistance over reactive and goal-only baselines.
Output: BeliefInference class wrapping particle filter, BeliefSensitiveHelper class, and intervention policy for deciding when/how to assist.
</objective>

<execution_context>
~/.cursor/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/bsa/common/types.py
@src/bsa/agents/helper/base.py
@src/bsa/inference/particle_filter.py
@src/bsa/inference/likelihood.py
@src/bsa/inference/goal.py
@src/bsa/envs/gridhouse/tasks.py
@.planning/phases/02-helper-models/02-04-SUMMARY.md

**Established patterns:**
- Particle filter and likelihood models from Plan 02-04
- HelperAgent interface from Plan 02-01
- Goal inference from Plan 02-03
- Type hints and docstrings throughout

**Key decisions:**
- Belief-sensitive helper uses particle filter for belief tracking
- Intervention policy decides when/how to assist based on false belief detection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create belief inference module</name>
  <files>src/bsa/inference/belief.py, src/bsa/inference/__init__.py</files>
  <action>
Create belief inference module in `src/bsa/inference/belief.py`:

1. **BeliefInference class:**
   - Wraps ParticleFilter and provides higher-level interface
   - Methods:
     - `__init__(task_list: List[Task], num_particles: int = 100, seed: Optional[int] = None)`: Initialize with particle filter
     - `update(human_action: Action, observation: Observation, true_locations: Dict[str, ObjectLocation], episode_step: Optional[EpisodeStep] = None) -> None`: Update beliefs from human action
     - `detect_false_belief(true_locations: Dict[str, ObjectLocation]) -> bool`: Detect if human has false belief (believed location != true location for any critical object)
     - `get_belief_state() -> Dict[str, Any]`: Return full belief state (goal distribution, object location beliefs)
     - `get_most_likely_goal() -> Optional[str]`: Get most likely goal
     - `get_most_likely_locations() -> Dict[str, ObjectLocation]`: Get MAP estimate of object locations
     - `reset() -> None`: Reset beliefs

2. **False belief detection:**
   - Compare most likely believed locations with true locations
   - Return True if any critical object has false belief (believed location != true location)
   - Can also return confidence/probability of false belief

3. **Type hints and docstrings:** Full type hints, docstrings

4. **Design considerations:**
   - Wraps particle filter for cleaner interface
   - Provides false belief detection logic
   - Returns belief state in format suitable for helper agent
  </action>
  <verify>python -c "from src.bsa.inference.belief import BeliefInference; from src.bsa.envs.gridhouse.tasks import list_tasks, get_task; tasks = [get_task(t) for t in list_tasks()]; bi = BeliefInference(tasks); assert bi.get_most_likely_goal() is not None or len(tasks) == 0; print('Belief inference created successfully')"</verify>
  <done>BeliefInference class exists, wraps particle filter, can detect false beliefs, returns belief state, no errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement intervention policy</name>
  <files>src/bsa/agents/helper/policies.py</files>
  <action>
Create intervention policy module in `src/bsa/agents/helper/policies.py`:

1. **InterventionPolicy class:**
   - Methods:
     - `should_intervene(belief_state: Dict[str, Any], true_locations: Dict[str, ObjectLocation], observation: Observation, task: Task) -> bool`: Decide if intervention is needed
     - `choose_intervention(belief_state: Dict[str, Any], true_locations: Dict[str, ObjectLocation], observation: Observation, task: Task) -> Action`: Choose intervention action
     - `get_intervention_type(belief_state: Dict[str, Any], true_locations: Dict[str, ObjectLocation]) -> str`: Return intervention type ("fetch", "communicate", "open", etc.)

2. **Intervention logic:**
   - **should_intervene:** Return True if false belief detected AND human is likely to waste actions
   - **choose_intervention:** 
     - If false belief: fetch object from true location and place at goal location, or communicate correction
     - If goal unclear: wait or explore
     - If no false belief: assist with goal (fetch objects, open containers)
   - **get_intervention_type:** Return type of intervention ("fetch", "communicate", "open", "wait")

3. **Type hints and docstrings:** Full type hints, docstrings

4. **Design considerations:**
   - Policy should minimize wasted actions
   - Prefer proactive intervention when false belief detected
   - Can use communication (SAY action) or direct action (fetch/place)
   - Consider human's current location and goal
  </action>
  <verify>python -c "from src.bsa.agents.helper.policies import InterventionPolicy; policy = InterventionPolicy(); assert policy.should_intervene({}, {}, None, None) in [True, False]; print('Intervention policy created successfully')"</verify>
  <done>InterventionPolicy class exists, should_intervene and choose_intervention methods work, no errors.</done>
</task>

<task type="auto">
  <name>Task 3: Implement belief-sensitive helper</name>
  <files>src/bsa/agents/helper/belief_sensitive.py, src/bsa/agents/helper/__init__.py</files>
  <action>
Create `BeliefSensitiveHelper` class in `src/bsa/agents/helper/belief_sensitive.py`:

1. **Class structure:**
   - Inherit from `HelperAgent`
   - Contains `BeliefInference` instance
   - Contains `InterventionPolicy` instance
   - Tracks human's goal and belief state

2. **plan_action method:**
   - Input: `observation: Observation`, optional `episode_step: Optional[EpisodeStep]`
   - Steps:
     - Update belief inference from human action (if episode_step available)
     - Detect false belief using belief inference
     - Use intervention policy to decide action
     - Return intervention action or assistive action
   - Return: `Action` enum value

3. **update_belief method:**
   - Extract human_action and true_locations from episode_step
   - Call belief_inference.update() to update particle filter

4. **get_belief_state method:**
   - Return belief_inference.get_belief_state() (full belief state with goal distribution and object location beliefs)

5. **detect_false_belief method:**
   - Use belief_inference.detect_false_belief() with true_locations from episode_step
   - Return True if false belief detected

6. **Type hints and docstrings:** Full type hints, docstrings

7. **Design considerations:**
   - Uses belief inference to track human's goal and beliefs
   - Uses intervention policy to decide when/how to assist
   - Can detect false beliefs and intervene proactively
   - More sophisticated than reactive or goal-only helpers
  </action>
  <verify>python -c "from src.bsa.agents.helper.belief_sensitive import BeliefSensitiveHelper; from src.bsa.agents.helper import HelperAgent; h = BeliefSensitiveHelper(); assert isinstance(h, HelperAgent); state = h.get_belief_state(); assert isinstance(state, dict); print('Belief-sensitive helper created successfully')"</verify>
  <done>BeliefSensitiveHelper class exists, implements HelperAgent interface, uses BeliefInference and InterventionPolicy, detect_false_belief works, plan_action returns valid Action, no errors.</done>
</task>

<task type="auto">
  <name>Task 4: Export belief-sensitive helper from module</name>
  <files>src/bsa/agents/helper/__init__.py</files>
  <action>
Update `src/bsa/agents/helper/__init__.py` to also export `BeliefSensitiveHelper` from `belief_sensitive.py`. Keep existing exports.
</action>
  <verify>python -c "from src.bsa.agents.helper import BeliefSensitiveHelper, GoalOnlyHelper, ReactiveHelper, HelperAgent; print('All exports successful')"</verify>
  <done>BeliefSensitiveHelper can be imported from src.bsa.agents.helper module alongside other helpers.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.bsa.inference.belief import BeliefInference"` succeeds
- [ ] `python -c "from src.bsa.agents.helper.policies import InterventionPolicy"` succeeds
- [ ] `python -c "from src.bsa.agents.helper import BeliefSensitiveHelper"` succeeds
- [ ] BeliefInference detects false beliefs correctly
- [ ] InterventionPolicy chooses appropriate interventions
- [ ] BeliefSensitiveHelper uses belief inference and intervention policy
- [ ] detect_false_belief method works
- [ ] Type hints and docstrings complete
</verification>

<success_criteria>

- BeliefInference class wraps particle filter and provides belief tracking
- InterventionPolicy class decides when/how to intervene
- BeliefSensitiveHelper class implements HelperAgent interface
- Belief-sensitive helper tracks human's goal and beliefs
- False belief detection works correctly
- Intervention policy chooses appropriate actions
- All helpers exported from module
- No errors on instantiation or method calls
- Phase 2 complete: All three helper types (reactive, goal-only, belief-sensitive) implemented
  </success_criteria>

<output>
After completion, create `.planning/phases/02-helper-models/02-05-SUMMARY.md`:

# Phase 2 Plan 5: Belief Inference + Belief-Sensitive Helper + Intervention Policy Summary

**Implemented belief-sensitive helper with particle filter and intervention policy**

## Accomplishments

- Created BeliefInference class wrapping particle filter for belief tracking
- Implemented InterventionPolicy class for deciding when/how to assist
- Created BeliefSensitiveHelper class that tracks beliefs and intervenes proactively
- False belief detection implemented
- All three helper types (reactive, goal-only, belief-sensitive) now complete

## Files Created/Modified

- `src/bsa/inference/belief.py` - BeliefInference class
- `src/bsa/agents/helper/policies.py` - InterventionPolicy class
- `src/bsa/agents/helper/belief_sensitive.py` - BeliefSensitiveHelper class
- `src/bsa/agents/helper/__init__.py` - Export BeliefSensitiveHelper
- `src/bsa/inference/__init__.py` - Export BeliefInference

## Decisions Made

- Belief inference wraps particle filter for cleaner interface
- Intervention policy decides when/how to assist based on false belief detection
- Belief-sensitive helper uses both belief inference and intervention policy
- False belief detection compares believed vs true locations

## Issues Encountered

[None or list issues]

## Next Step

Phase 2 complete. Ready for Phase 3 (VirtualHome Backend) or Phase 4 (Experiment Harness).
</output>
